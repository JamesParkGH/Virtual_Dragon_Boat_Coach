{% extends "base.html" %}

{% block content %}
<section class="feedback-section">
    <div class="page-header">
        <h1><i class="fas fa-chart-line"></i> Technique Analysis & Feedback</h1>
        <p class="subtitle">Review your paddling technique with AI-powered analysis</p>
    </div>
    
    <div class="dashboard-container">
        <!-- Control Panel -->
        <div class="panel control-panel">
            <div class="panel-header">
                <h2><i class="fas fa-sliders-h"></i> Control Panel</h2>
            </div>
            <div class="panel-body">
                <div class="form-controls">
                    <form action="/generate-graph" method="POST" id="feedbackForm">
                        <div class="form-group">
                            <label for="angle-name"><i class="fas fa-chart-line"></i> Select Angle to Graph</label>
                            <select id="angle-name" name="angle_name" required>
                                <option value="">-- Select an angle --</option>
                                <optgroup label="Pelvis">
                                    <option value="pelvis_tilt">Pelvis Tilt</option>
                                    <option value="pelvis_list">Pelvis List</option>
                                    <option value="pelvis_rotation">Pelvis Rotation</option>
                                    <option value="pelvis_tx">Pelvis TX</option>
                                    <option value="pelvis_ty">Pelvis TY</option>
                                    <option value="pelvis_tz">Pelvis TZ</option>
                                </optgroup>
                                <optgroup label="Right Side">
                                    <option value="hip_flexion_r">Hip Flexion Right</option>
                                    <option value="hip_adduction_r">Hip Adduction Right</option>
                                    <option value="hip_rotation_r">Hip Rotation Right</option>
                                    <option value="knee_angle_r">Knee Angle Right</option>
                                    <option value="ankle_angle_r">Ankle Angle Right</option>
                                    <option value="subtalar_angle_r">Subtalar Angle Right</option>
                                    <option value="mtp_angle_r">MTP Angle Right</option>
                                    <option value="arm_flex_r">Arm Flex Right</option>
                                    <option value="arm_add_r">Arm Add Right</option>
                                    <option value="arm_rot_r">Arm Rot Right</option>
                                    <option value="elbow_flex_r">Elbow Flex Right</option>
                                    <option value="pro_sup_r">Pro Sup Right</option>
                                </optgroup>
                                <optgroup label="Left Side">
                                    <option value="hip_flexion_l">Hip Flexion Left</option>
                                    <option value="hip_adduction_l">Hip Adduction Left</option>
                                    <option value="hip_rotation_l">Hip Rotation Left</option>
                                    <option value="knee_angle_l">Knee Angle Left</option>
                                    <option value="ankle_angle_l">Ankle Angle Left</option>
                                    <option value="subtalar_angle_l">Subtalar Angle Left</option>
                                    <option value="mtp_angle_l">MTP Angle Left</option>
                                    <option value="arm_flex_l">Arm Flex Left</option>
                                    <option value="arm_add_l">Arm Add Left</option>
                                    <option value="arm_rot_l">Arm Rot Left</option>
                                    <option value="elbow_flex_l">Elbow Flex Left</option>
                                    <option value="pro_sup_l">Pro Sup Left</option>
                                </optgroup>
                                <optgroup label="Spine">
                                    <option value="lumbar_extension">Lumbar Extension</option>
                                    <option value="lumbar_bending">Lumbar Bending</option>
                                    <option value="lumbar_rotation">Lumbar Rotation</option>
                                </optgroup>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-chart-bar"></i> Generate Graph</button>
                    </form>
                    <form action="/run-opensim" method="POST" id="opensimForm">
                        <button type="submit" class="btn btn-secondary"><i class="fas fa-cogs"></i> Run Opensim</button>
                    </form>
                </div>
            </div>
        </div>

        {% if error %}
            <div class="alert alert-error"><i class="fas fa-exclamation-circle"></i> {{ error }}</div>
        {% endif %}

        <!-- Analysis Results -->
        {% if image_filename %}
            <div class="panel analysis-results">
                <div class="panel-header">
                    <h2><i class="fas fa-chart-line"></i> Analysis Results</h2>
                </div>
                <div class="panel-body">
                    <img src="{{ url_for('static', filename='Feedback/' ~ image_filename) }}" alt="Analysis Result Graph" class="img-fluid">
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Feedback Results -->
    {% if feedback %}
        <div class="feedback-dashboard">
            <div class="section-header">
                <h2><i class="fas fa-clipboard-check"></i> Technique Feedback</h2>
                <p>Review your technique performance and suggested improvements</p>
            </div>
            
            <div class="feedback-grid">
                <!-- Top Arm Feedback -->
                {% if feedback.top_arm %}
                <div class="feedback-category card">
                    <div class="card-header" data-rating="{{ feedback.top_arm.rating|lower }}">
                        <div class="header-content">
                            <h3><i class="fas fa-hand-point-up"></i> Top Arm</h3>
                            <span class="rating rating-{{ feedback.top_arm.rating|lower }}">{{ feedback.top_arm.rating }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="main-points">
                            {% for point in feedback.top_arm.main_points %}
                                <p><i class="fas fa-angle-right"></i> {{ point }}</p>
                            {% endfor %}
                        </div>
                        
                        {% if feedback.top_arm.rating != 'Good' %}
                            <div class="improvement-points">
                                <h4><i class="fas fa-tools"></i> Improvement Points</h4>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Limiting Factors</h5>
                                    <ul>
                                        {% for factor in feedback.top_arm.improvement_points.limiting_factors %}
                                            <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-heartbeat"></i> Potential Injuries</h5>
                                    <ul>
                                        {% for injury in feedback.top_arm.improvement_points.potential_injuries %}
                                            <li>{{ injury }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-lightbulb"></i> Technical Feedback</h5>
                                    <ul>
                                        {% for tip in feedback.top_arm.improvement_points.technical_feedback %}
                                            <li>{{ tip }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-dumbbell"></i> Corrective Exercises</h5>
                                    <ul>
                                        {% for exercise in feedback.top_arm.improvement_points.corrective_exercises %}
                                            <li>{{ exercise }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Bottom Arm Feedback -->
                {% if feedback.bottom_arm %}
                <div class="feedback-category card">
                    <div class="card-header" data-rating="{{ feedback.bottom_arm.rating|lower }}">
                        <div class="header-content">
                            <h3><i class="fas fa-hand-point-down"></i> Bottom Arm</h3>
                            <span class="rating rating-{{ feedback.bottom_arm.rating|lower }}">{{ feedback.bottom_arm.rating }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="main-points">
                            {% for point in feedback.bottom_arm.main_points %}
                                <p><i class="fas fa-angle-right"></i> {{ point }}</p>
                            {% endfor %}
                        </div>
                        
                        {% if feedback.bottom_arm.rating != 'Good' %}
                            <div class="improvement-points">
                                <h4><i class="fas fa-tools"></i> Improvement Points</h4>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Limiting Factors</h5>
                                    <ul>
                                        {% for factor in feedback.bottom_arm.improvement_points.limiting_factors %}
                                            <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-heartbeat"></i> Potential Injuries</h5>
                                    <ul>
                                        {% for injury in feedback.bottom_arm.improvement_points.potential_injuries %}
                                            <li>{{ injury }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-lightbulb"></i> Technical Feedback</h5>
                                    <ul>
                                        {% for tip in feedback.bottom_arm.improvement_points.technical_feedback %}
                                            <li>{{ tip }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-dumbbell"></i> Corrective Exercises</h5>
                                    <ul>
                                        {% for exercise in feedback.bottom_arm.improvement_points.corrective_exercises %}
                                            <li>{{ exercise }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Posture Feedback -->
                {% if feedback.posture %}
                <div class="feedback-category card">
                    <div class="card-header" data-rating="{{ feedback.posture.rating|lower }}">
                        <div class="header-content">
                            <h3><i class="fas fa-user"></i> Posture</h3>
                            <span class="rating rating-{{ feedback.posture.rating|lower }}">{{ feedback.posture.rating }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="main-points">
                            {% for point in feedback.posture.main_points %}
                                <p><i class="fas fa-angle-right"></i> {{ point }}</p>
                            {% endfor %}
                        </div>
                        
                        {% if feedback.posture.rating != 'Good' %}
                            <div class="improvement-points">
                                <h4><i class="fas fa-tools"></i> Improvement Points</h4>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Limiting Factors</h5>
                                    <ul>
                                        {% for factor in feedback.posture.improvement_points.limiting_factors %}
                                            <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-heartbeat"></i> Potential Injuries</h5>
                                    <ul>
                                        {% for injury in feedback.posture.improvement_points.potential_injuries %}
                                            <li>{{ injury }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-lightbulb"></i> Technical Feedback</h5>
                                    <ul>
                                        {% for tip in feedback.posture.improvement_points.technical_feedback %}
                                            <li>{{ tip }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-dumbbell"></i> Corrective Exercises</h5>
                                    <ul>
                                        {% for exercise in feedback.posture.improvement_points.corrective_exercises %}
                                            <li>{{ exercise }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Paddle Angle Feedback -->
                {% if feedback.paddle_angle %}
                <div class="feedback-category card">
                    <div class="card-header" data-rating="{{ feedback.paddle_angle.rating|lower }}">
                        <div class="header-content">
                            <h3><i class="fas fa-ruler-combined"></i> Paddle Angle</h3>
                            <span class="rating rating-{{ feedback.paddle_angle.rating|lower }}">{{ feedback.paddle_angle.rating }}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="main-points">
                            {% for point in feedback.paddle_angle.main_points %}
                                <p><i class="fas fa-angle-right"></i> {{ point }}</p>
                            {% endfor %}
                        </div>
                        
                        {% if feedback.paddle_angle.rating != 'Good' %}
                            <div class="improvement-points">
                                <h4><i class="fas fa-tools"></i> Improvement Points</h4>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Limiting Factors</h5>
                                    <ul>
                                        {% for factor in feedback.paddle_angle.improvement_points.limiting_factors %}
                                            <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                {% if feedback.paddle_angle.improvement_points.potential_injuries %}
                                <div class="improvement-section">
                                    <h5><i class="fas fa-heartbeat"></i> Potential Injuries</h5>
                                    <ul>
                                        {% for injury in feedback.paddle_angle.improvement_points.potential_injuries %}
                                            <li>{{ injury }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-lightbulb"></i> Technical Feedback</h5>
                                    <ul>
                                        {% for tip in feedback.paddle_angle.improvement_points.technical_feedback %}
                                            <li>{{ tip }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                
                                <div class="improvement-section">
                                    <h5><i class="fas fa-dumbbell"></i> Corrective Exercises</h5>
                                    <ul>
                                        {% for exercise in feedback.paddle_angle.improvement_points.corrective_exercises %}
                                            <li>{{ exercise }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    {% endif %}
</section>

<style>
/* Feedback Page Specific Styles */
.feedback-section {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
    font-family: 'Poppins', sans-serif;
}

.page-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.page-header h1 {
    font-size: 2.2rem;
    font-weight: 600;
    color: #8B0000; /* Maroon color matching logo */
    margin-bottom: 0.5rem;
}

.subtitle {
    font-size: 1.1rem;
    color: #666;
    margin-top: 0;
}

/* Panel styles */
.panel {
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    overflow: hidden;
}

.panel-header {
    padding: 1rem 1.5rem;
    background-color: #8B0000; /* Maroon color matching logo */
    color: white;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
}

.panel-header h2 {
    font-size: 1.5rem;
    margin: 0;
    font-weight: 500;
}

.panel-body {
    padding: 1.5rem;
}

/* Control panel */
.dashboard-container {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.form-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
}

#feedbackForm {
    flex: 1;
    min-width: 300px;
}

.form-group {
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: #333;
}

select {
    padding: 12px;
    border-radius: 5px;
    border: 1px solid #ddd;
    background-color: white;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    transition: border 0.3s ease;
}

select:focus {
    border-color: #8B0000;
    outline: none;
    box-shadow: 0 0 0 2px rgba(139,0,0,0.2);
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 5px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.btn i {
    font-size: 0.9rem;
}

.btn-primary {
    background-color: #8B0000;
    color: white;
}

.btn-primary:hover {
    background-color: #6b0000;
}

.btn-secondary {
    background-color: #555;
    color: white;
}

.btn-secondary:hover {
    background-color: #444;
}

/* Analysis results */
.analysis-results img {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Feedback results */
.feedback-dashboard {
    margin-top: 3rem;
}

.section-header {
    margin-bottom: 2rem;
    text-align: center;
}

.section-header h2 {
    font-size: 2rem;
    color: #333;
    margin-bottom: 0.5rem;
}

.section-header p {
    color: #666;
    margin-top: 0;
}

.feedback-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
    gap: 2rem;
}

.card {
    border-radius: 10px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    background: white;
    overflow: hidden;
    height: 100%;
}

.card-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
    position: relative;
}

.card-header[data-rating="good"] {
    background-color: #2ecc71;
    color: white;
}

.card-header[data-rating="moderate"] {
    background-color: #f1c40f;
    color: #333;
}

.card-header[data-rating="bad"] {
    background-color: #e74c3c;
    color: white;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    font-size: 1.3rem;
    margin: 0;
    font-weight: 500;
}

.rating {
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.9rem;
    display: inline-block;
}

.card-body {
    padding: 1.5rem;
}

.main-points {
    margin-bottom: 1.5rem;
}

.main-points p {
    margin-bottom: 0.7rem;
    display: flex;
    align-items: flex-start;
}

.main-points p i {
    margin-right: 0.5rem;
    margin-top: 0.3rem;
    color: #8B0000;
}

.improvement-points h4 {
    font-size: 1.2rem;
    margin: 1.5rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
    color: #333;
}

.improvement-section {
    margin-bottom: 1.2rem;
    background-color: #f9f9f9;
    padding: 1rem;
    border-radius: 5px;
}

.improvement-section h5 {
    font-size: 1rem;
    color: #555;
    margin-top: 0;
    margin-bottom: 0.7rem;
    font-weight: 500;
}

.improvement-section ul {
    margin: 0;
    padding-left: 1.5rem;
}

.improvement-section li {
    margin-bottom: 0.5rem;
}

/* Alerts */
.alert {
    padding: 1rem 1.5rem;
    border-radius: 5px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.7rem;
}

.alert-error {
    background-color: #ffecec;
    color: #e74c3c;
    border-left: 4px solid #e74c3c;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .feedback-grid {
        grid-template-columns: 1fr;
    }
    
    .form-controls {
        flex-direction: column;
    }
    
    #feedbackForm, #opensimForm {
        width: 100%;
    }
    
    .btn {
        width: 100%;
    }
}
</style>
{% endblock %}